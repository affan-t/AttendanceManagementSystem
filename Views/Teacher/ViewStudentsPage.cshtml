@model IEnumerable<AttendanceManagementSystem.Models.Enrollment>

@{
    ViewData["Title"] = "My Students";
    var allocation = ViewBag.Allocation as AttendanceManagementSystem.Models.CourseAllocation;
    var studentAttendance = ViewBag.StudentAttendance as Dictionary<int, (int Total, int Present, double Percentage)>;
}

<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="page-title"><i class="bi bi-people me-2"></i>My Students</h1>
        <p class="page-subtitle mb-0">
            <span class="badge badge-primary">@allocation?.Course?.Code</span>
            @allocation?.Course?.Name - @allocation?.Batch?.Name / @allocation?.Section?.Name
        </p>
    </div>
    <div class="d-flex gap-2">
        <a href="@Url.Action("AttendanceReport", new { id = allocation?.Id })" class="btn btn-primary">
            <i class="bi bi-file-earmark-bar-graph me-1"></i>View Report
        </a>
        <a href="@Url.Action("ViewStudents")" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>Back
        </a>
    </div>
</div>

<!-- Course Info Card -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <small class="text-muted">Teacher</small>
                <div class="fw-medium">@allocation?.Teacher?.Name</div>
            </div>
            <div class="col-md-3">
                <small class="text-muted">Section</small>
                <div class="fw-medium">@allocation?.Section?.Name</div>
            </div>
            <div class="col-md-3">
                <small class="text-muted">Batch</small>
                <div class="fw-medium">@allocation?.Batch?.Name</div>
            </div>
            <div class="col-md-3">
                <small class="text-muted">Semester</small>
                <div class="fw-medium">@allocation?.Semester?.Name</div>
            </div>
        </div>
    </div>
</div>

@if (!Model.Any())
{
    <div class="card">
        <div class="card-body">
            <div class="empty-state py-5">
                <div class="empty-state-icon"><i class="bi bi-people"></i></div>
                <h5 class="empty-state-title">No Students Enrolled</h5>
                <p class="empty-state-text">No students have registered for this course section yet.</p>
            </div>
        </div>
    </div>
}
else
{
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="bi bi-list-ul me-2"></i>Student List</h6>
            <span class="badge bg-secondary">@Model.Count() students</span>
        </div>
        <div class="table-responsive">
            <table class="table mb-0">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Roll No</th>
                        <th>Student Name</th>
                        <th>Father's Name</th>
                        <th>Department</th>
                        <th class="text-center">Classes</th>
                        <th class="text-center">Present</th>
                        <th class="text-center">Attendance</th>
                        <th class="text-center">Status</th>
                    </tr>
                </thead>
                <tbody>
                    @{int counter = 1;}
                    @foreach (var enrollment in Model)
                    {
                        var attendance = studentAttendance?.ContainsKey(enrollment.StudentId) == true 
                            ? studentAttendance[enrollment.StudentId] 
                            : (0, 0, 0.0);
                        int attTotal = attendance.Item1;
                        int attPresent = attendance.Item2;
                        double percentage = attendance.Item3;
                        string badgeClass = percentage >= 75 ? "badge-success" : (percentage >= 60 ? "badge-warning" : "badge-danger");
                        string statusText = percentage >= 75 ? "Good" : (percentage >= 60 ? "Warning" : "Critical");
                        <tr>
                            <td class="text-muted">@counter</td>
                            <td><span class="badge badge-secondary">@enrollment.Student.RollNo</span></td>
                            <td class="fw-medium">@enrollment.Student.Name</td>
                            <td class="text-muted">@enrollment.Student.FatherName</td>
                            <td>@enrollment.Student.Department</td>
                            <td class="text-center">@attTotal</td>
                            <td class="text-center text-success fw-medium">@attPresent</td>
                            <td class="text-center">
                                @if (attTotal > 0)
                                {
                                    <span class="badge @badgeClass">@percentage%</span>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td class="text-center">
                                @if (attTotal > 0)
                                {
                                    <span class="badge @badgeClass">@statusText</span>
                                }
                                else
                                {
                                    <span class="badge badge-secondary">No Data</span>
                                }
                            </td>
                        </tr>
                        counter++;
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="mt-4 d-flex gap-2 flex-wrap">
        <a href="@Url.Action("MarkAttendance", new { id = allocation?.Id })" class="btn btn-success">
            <i class="bi bi-check2-square me-1"></i>Mark Attendance
        </a>
        <a href="@Url.Action("AttendanceHistory", new { id = allocation?.Id })" class="btn btn-outline-primary">
            <i class="bi bi-clock-history me-1"></i>Attendance History
        </a>
        <a href="@Url.Action("LowAttendanceStudents", new { id = allocation?.Id })" class="btn btn-outline-danger">
            <i class="bi bi-exclamation-triangle me-1"></i>Low Attendance
        </a>
    </div>

    <!-- Legend -->
    <div class="mt-3 text-muted small">
        <strong>Legend:</strong>
        <span class="badge badge-success ms-2">?75%</span> Good Standing
        <span class="badge badge-warning ms-2">60-74%</span> Warning
        <span class="badge badge-danger ms-2">&lt;60%</span> Critical
    </div>
}
