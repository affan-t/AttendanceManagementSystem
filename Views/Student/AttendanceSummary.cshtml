@model List<dynamic>

@{
    ViewData["Title"] = "Attendance Summary";
    var student = ViewBag.Student as AttendanceManagementSystem.Models.Student;
}

<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="page-title"><i class="bi bi-bar-chart me-2"></i>Attendance Summary</h1>
        <p class="page-subtitle mb-0">Overview of your attendance across all courses</p>
    </div>
    <div class="d-flex gap-2">
        <a href="@Url.Action("MyReport")" class="btn btn-primary">
            <i class="bi bi-file-earmark-bar-graph me-1"></i>Full Report
        </a>
        <button type="button" class="btn btn-success" onclick="window.print()">
            <i class="bi bi-printer me-1"></i>Print
        </button>
        <a asp-action="Index" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>Back
        </a>
    </div>
</div>

@if (!Model.Any())
{
    <div class="card">
        <div class="card-body">
            <div class="empty-state">
                <div class="empty-state-icon"><i class="bi bi-journal-x"></i></div>
                <h5 class="empty-state-title">No Courses Found</h5>
                <p class="empty-state-text">You are not enrolled in any courses yet.</p>
            </div>
        </div>
    </div>
}
else
{
    var allTotal = Model.Sum(m => (int)m.TotalClasses);
    var allPresent = Model.Sum(m => (int)m.PresentCount);
    var allAbsent = allTotal - allPresent;
    var overallPercentage = allTotal > 0 ? Math.Round((double)allPresent / allTotal * 100, 1) : 0;
    string statusColor = overallPercentage >= 75 ? "success" : (overallPercentage >= 60 ? "warning" : "danger");

    <!-- Stats Cards Row -->
    <div class="row g-3 mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="stat-card">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="stat-card-value">@Model.Count</div>
                        <div class="stat-card-label">Enrolled Courses</div>
                    </div>
                    <div class="stat-card-icon primary">
                        <i class="bi bi-book"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stat-card">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="stat-card-value">@allTotal</div>
                        <div class="stat-card-label">Total Classes</div>
                    </div>
                    <div class="stat-card-icon info">
                        <i class="bi bi-calendar-check"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stat-card">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="stat-card-value text-success">@allPresent</div>
                        <div class="stat-card-label">Classes Attended</div>
                    </div>
                    <div class="stat-card-icon success">
                        <i class="bi bi-check-circle"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stat-card">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="stat-card-value text-@statusColor">@overallPercentage%</div>
                        <div class="stat-card-label">Overall Attendance</div>
                    </div>
                    <div class="stat-card-icon @statusColor">
                        <i class="bi bi-pie-chart"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart and Status Card -->
    <div class="row g-4 mb-4">
        <!-- Pie Chart -->
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-pie-chart me-2"></i>Attendance Distribution</h6>
                </div>
                <div class="card-body d-flex align-items-center justify-content-center">
                    <div class="chart-container" style="width: 100%; height: 250px;">
                        <canvas id="attendanceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Status Card -->
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>Attendance Status</h6>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="fw-medium">Overall Progress</span>
                            <span class="fw-bold text-@statusColor">@overallPercentage%</span>
                        </div>
                        <div class="progress" style="height: 12px;">
                            <div class="progress-bar bg-@statusColor" style="width: @overallPercentage%"></div>
                        </div>
                        <small class="text-muted mt-1 d-block">Minimum required: 75%</small>
                    </div>
                    
                    @if (overallPercentage >= 75)
                    {
                        <div class="alert alert-success mb-0">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-check-circle-fill fs-4 me-3"></i>
                                <div>
                                    <strong>Good Standing!</strong>
                                    <p class="mb-0 small">Your attendance meets the minimum requirement. Keep up the good work!</p>
                                </div>
                            </div>
                        </div>
                    }
                    else if (overallPercentage >= 60)
                    {
                        <div class="alert alert-warning mb-0">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
                                <div>
                                    <strong>Warning!</strong>
                                    <p class="mb-0 small">Your attendance is below 75%. You need @(Math.Ceiling((0.75 * allTotal - allPresent) / 0.25)) more classes to reach the minimum.</p>
                                </div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-danger mb-0">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-x-circle-fill fs-4 me-3"></i>
                                <div>
                                    <strong>Critical!</strong>
                                    <p class="mb-0 small">Your attendance is critically low. Please contact your advisor immediately.</p>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Course-wise Table -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="bi bi-table me-2"></i>Course-wise Attendance</h6>
            <span class="badge bg-secondary">@Model.Count courses</span>
        </div>
        <div class="table-responsive">
            <table class="table mb-0">
                <thead>
                    <tr>
                        <th>Course</th>
                        <th>Teacher</th>
                        <th class="text-center">Total</th>
                        <th class="text-center">Present</th>
                        <th class="text-center">Absent</th>
                        <th class="text-center">Percentage</th>
                        <th class="text-center">Status</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        var enrollment = item.Enrollment as AttendanceManagementSystem.Models.Enrollment;
                        double percentage = item.Percentage;
                        string badgeClass = percentage >= 75 ? "badge-success" : (percentage >= 60 ? "badge-warning" : "badge-danger");
                        string statusText = percentage >= 75 ? "Good" : (percentage >= 60 ? "Warning" : "Critical");
                        
                        <tr>
                            <td>
                                <div class="fw-semibold">@enrollment?.CourseAllocation?.Course?.Name</div>
                                <small class="text-muted">@enrollment?.CourseAllocation?.Course?.Code</small>
                            </td>
                            <td>@enrollment?.CourseAllocation?.Teacher?.Name</td>
                            <td class="text-center">@item.TotalClasses</td>
                            <td class="text-center"><span class="text-success fw-semibold">@item.PresentCount</span></td>
                            <td class="text-center"><span class="text-danger fw-semibold">@item.AbsentCount</span></td>
                            <td class="text-center">
                                @if ((int)item.TotalClasses > 0)
                                {
                                    <span class="badge @badgeClass">@percentage%</span>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td class="text-center">
                                @if ((int)item.TotalClasses > 0)
                                {
                                    <span class="badge @badgeClass">@statusText</span>
                                }
                                else
                                {
                                    <span class="badge badge-secondary">No Data</span>
                                }
                            </td>
                            <td>
                                <a asp-action="ViewAttendance" asp-route-id="@enrollment?.CourseAllocationId" 
                                   class="btn btn-sm btn-outline-primary" title="View Details">
                                    <i class="bi bi-eye"></i>
                                </a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- Legend -->
    <div class="mt-3 text-muted small">
        <strong>Legend:</strong>
        <span class="badge badge-success ms-2">?75%</span> Good Standing
        <span class="badge badge-warning ms-2">60-74%</span> Warning
        <span class="badge badge-danger ms-2">&lt;60%</span> Critical
    </div>
}

@section Scripts {
    <script>
        @if (Model.Any())
        {
            var allTotal = Model.Sum(m => (int)m.TotalClasses);
            var allPresent = Model.Sum(m => (int)m.PresentCount);
            var allAbsent = allTotal - allPresent;
            
            <text>
            // Attendance Pie Chart
            const ctx = document.getElementById('attendanceChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Present', 'Absent'],
                    datasets: [{
                        data: [@allPresent, @allAbsent],
                        backgroundColor: ['#10b981', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    cutout: '60%'
                }
            });
            </text>
        }
    </script>
}
